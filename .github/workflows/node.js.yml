name: "üöÄ Node.js CI & Deploy to EC2"

on:
  push:
    branches: [ "master" ]   # yahi branch pe deploy chahiye
  workflow_dispatch:

jobs:
  deploy:
    runs-on:
      - self-hosted
      - Linux
      - X64

    env:
      RUNNER_TEMP: /home/ubuntu/actions-runner/_temp
      RUNNER_TOOL_CACHE: /home/ubuntu/actions-runner/_tool

    steps:
      - name: "üì• Checkout code"
        uses: actions/checkout@v4

      - name: "üõ† Prepare temp/cache dirs"
        run: |
          mkdir -p "$RUNNER_TEMP" "$RUNNER_TOOL_CACHE"

      - name: "üü¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: "üì¶ Install dependencies"
        run: npm ci

      # ‡§Ø‡•á step ‡§∏‡§π‡•Ä ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á check ‡§ï‡§∞‡•á‡§ó‡§æ ‡§ï‡§ø build script ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç
      - name: "üß™ Build (if script exists)"
        run: |
          if node -e "const p=require('./package.json'); process.exit(p.scripts && p.scripts.build ? 0 : 1)"; then
            echo "‚úÖ Build script ‡§Æ‡§ø‡§≤‡§æ, npm run build ‡§ö‡§≤‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‚Ä¶"
            npm run build
          else
            echo "‚ÑπÔ∏è Build script ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, build step skip ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§"
          fi

      - name: "üöÄ Deploy with PM2 (src/server.js)"
        shell: bash
        run: |
          set -e

          # PM2 installed ‡§π‡•à ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç, check ‡§ï‡§∞‡•á‡§Ç
          if ! command -v pm2 >/dev/null 2>&1; then
            echo "PM2 ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, install ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‚Ä¶"
            sudo npm i -g pm2
          fi

          APP_NAME="batchcode-backend"
          APP_CWD="$(pwd)"   # ‡§Ö‡§≠‡•Ä ‡§ï‡•á repo ‡§ï‡§æ path (GitHub workspace)

          echo "Using APP_NAME=$APP_NAME"
          echo "Using APP_CWD=$APP_CWD"

          # ‡§Ö‡§ó‡§∞ ‡§™‡§π‡§≤‡•á ‡§∏‡•á process ‡§π‡•à ‡§§‡•ã reload ‡§ï‡§∞‡•ã, ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§§‡•ã ‡§®‡§Ø‡§æ start ‡§ï‡§∞‡•ã
          if pm2 describe "${APP_NAME}" >/dev/null 2>&1; then
            echo "üåÄ Existing PM2 process ‡§Æ‡§ø‡§≤‡§æ, reload ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‚Ä¶"
            pm2 reload "${APP_NAME}" --update-env
          else
            echo "‚ú® PM2 process ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, ‡§®‡§Ø‡§æ start ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‚Ä¶"
            pm2 start "${APP_CWD}/src/server.js" --name "${APP_NAME}"
          fi

          # Process list save (reboot ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§ï‡•á ‡§≤‡§ø‡§è)
          pm2 save || true

          echo "‚úÖ PM2 status:"
          pm2 status
